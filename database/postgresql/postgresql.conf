# =====================================================
# PostgreSQL Configuration for Discord Activity Bot
# =====================================================
# Termux 환경에 최적화된 PostgreSQL 설정 파일
# 메모리 제한이 있는 모바일 환경을 고려한 설정

# -----------------------------------------------------
# CONNECTION AND AUTHENTICATION
# -----------------------------------------------------

# 연결 설정
listen_addresses = 'localhost'          # localhost만 허용 (보안)
port = 5432                             # 기본 포트
max_connections = 20                    # Termux 환경에 맞는 연결 수 제한

# 인증 설정
authentication_timeout = 60s           # 인증 타임아웃

# -----------------------------------------------------
# RESOURCE USAGE (MEMORY)
# -----------------------------------------------------

# 메모리 설정 (Termux 환경 고려)
shared_buffers = 64MB                   # 공유 버퍼 (전체 메모리의 25% 정도)
effective_cache_size = 256MB            # 시스템 캐시 크기 추정값
work_mem = 4MB                          # 쿼리 작업 메모리
maintenance_work_mem = 16MB             # 유지보수 작업 메모리
dynamic_shared_memory_type = posix      # 공유 메모리 타입

# -----------------------------------------------------
# WRITE AHEAD LOG (WAL)
# -----------------------------------------------------

# WAL 설정
wal_buffers = 2MB                       # WAL 버퍼 크기
checkpoint_completion_target = 0.9      # 체크포인트 완료 목표
checkpoint_timeout = 15min              # 체크포인트 간격
max_wal_size = 200MB                    # 최대 WAL 크기
min_wal_size = 50MB                     # 최소 WAL 크기

# WAL 아카이빙 (백업용)
archive_mode = off                      # 아카이빙 비활성화 (개발환경)
# archive_command = 'cp %p /path/to/archive/%f'  # 프로덕션시 활성화

# -----------------------------------------------------
# QUERY TUNING
# -----------------------------------------------------

# 쿼리 최적화
random_page_cost = 1.1                  # SSD 환경을 고려한 랜덤 페이지 비용
effective_io_concurrency = 200          # 동시 I/O 작업 수
default_statistics_target = 100         # 통계 수집 대상

# 쿼리 계획
# enable_seqscan = on                   # 순차 스캔 허용
# enable_indexscan = on                 # 인덱스 스캔 허용
# enable_hashjoin = on                  # 해시 조인 허용

# -----------------------------------------------------
# ERROR REPORTING AND LOGGING
# -----------------------------------------------------

# 로깅 설정
log_destination = 'stderr'              # 로그 출력 대상
logging_collector = on                  # 로그 수집기 활성화
log_directory = 'pg_log'                # 로그 디렉토리
log_filename = 'postgresql-%Y-%m-%d.log' # 로그 파일명 패턴
log_rotation_age = 1d                   # 로그 순환 주기
log_rotation_size = 100MB               # 로그 파일 최대 크기

# 로그 레벨
log_min_messages = warning              # 최소 로그 레벨
log_min_error_statement = error         # 에러 문장 로깅
log_min_duration_statement = 1000       # 1초 이상 쿼리 로깅

# 로그 내용
log_connections = on                    # 연결 로깅
log_disconnections = on                 # 연결 해제 로깅
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ' # 로그 접두사
log_statement = 'mod'                   # DDL/DML 문장 로깅
log_lock_waits = on                     # 락 대기 로깅
log_temp_files = 10MB                   # 임시 파일 로깅 (10MB 이상)

# -----------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------

# 클라이언트 기본값
default_text_search_config = 'pg_catalog.english'
timezone = 'UTC'                        # UTC 타임존 사용
datestyle = 'iso, mdy'                  # 날짜 스타일
lc_messages = 'C'                       # 메시지 언어
lc_monetary = 'C'                       # 통화 형식
lc_numeric = 'C'                        # 숫자 형식
lc_time = 'C'                           # 시간 형식

# -----------------------------------------------------
# AUTOVACUUM PARAMETERS
# -----------------------------------------------------

# 자동 정리 (Autovacuum) 설정
autovacuum = on                         # 자동 정리 활성화
autovacuum_max_workers = 2              # 최대 워커 수 (Termux 고려)
autovacuum_naptime = 1min               # 실행 간격
autovacuum_vacuum_threshold = 50        # VACUUM 임계값
autovacuum_analyze_threshold = 50       # ANALYZE 임계값
autovacuum_vacuum_scale_factor = 0.2    # VACUUM 스케일 팩터
autovacuum_analyze_scale_factor = 0.1   # ANALYZE 스케일 팩터

# -----------------------------------------------------
# STATISTICS
# -----------------------------------------------------

# 통계 수집
track_activities = on                   # 활동 추적
track_counts = on                       # 카운트 추적
track_io_timing = on                    # I/O 타이밍 추적
track_functions = all                   # 함수 통계 추적

# 통계 뷰 업데이트
stats_temp_directory = 'pg_stat_tmp'    # 임시 통계 디렉토리

# -----------------------------------------------------
# CUSTOM SETTINGS FOR DISCORD BOT
# -----------------------------------------------------

# Discord Bot 전용 설정
shared_preload_libraries = ''           # 미리 로드할 라이브러리 없음

# 세션 기본값
statement_timeout = 30s                 # 문장 실행 타임아웃
lock_timeout = 10s                      # 락 타임아웃
idle_in_transaction_session_timeout = 60s # 트랜잭션 내 유휴 타임아웃

# 백그라운드 작업
max_worker_processes = 4                # 최대 워커 프로세스
max_parallel_workers = 2                # 최대 병렬 워커
max_parallel_workers_per_gather = 1     # 쿼리당 최대 병렬 워커

# -----------------------------------------------------
# TERMUX SPECIFIC OPTIMIZATIONS
# -----------------------------------------------------

# Termux 환경 최적화
fsync = on                              # 데이터 안전성 보장
synchronous_commit = on                 # 동기 커밋 (안전성)
full_page_writes = on                   # 전체 페이지 쓰기 (복구 안전성)

# 성능 vs 안전성 트레이드오프 (개발환경에서는 성능 우선 가능)
# fsync = off                           # 개발시에는 비활성화 가능
# synchronous_commit = off              # 개발시에는 비활성화 가능

# -----------------------------------------------------
# MEMORY OPTIMIZATION FOR SMALL DEVICES
# -----------------------------------------------------

# 소형 디바이스용 메모리 최적화
temp_buffers = 8MB                      # 임시 버퍼
max_prepared_transactions = 0           # 준비된 트랜잭션 비활성화
max_files_per_process = 100             # 프로세스당 최대 파일 수

# 체크포인트 최적화
checkpoint_warning = 30s                # 체크포인트 경고 시간

# -----------------------------------------------------
# VACUUM AND ANALYZE SETTINGS
# -----------------------------------------------------

# 정리 작업 최적화
vacuum_cost_delay = 10ms                # VACUUM 비용 지연
vacuum_cost_page_hit = 1                # 페이지 히트 비용
vacuum_cost_page_miss = 10              # 페이지 미스 비용
vacuum_cost_page_dirty = 20             # 더티 페이지 비용
vacuum_cost_limit = 200                 # VACUUM 비용 제한

# -----------------------------------------------------
# EXTENSIONS AND MODULES
# -----------------------------------------------------

# 확장 기능 설정 (필요시 주석 해제)
# shared_preload_libraries = 'pg_stat_statements'
# pg_stat_statements.max = 10000
# pg_stat_statements.track = all

# -----------------------------------------------------
# EOF
# -----------------------------------------------------